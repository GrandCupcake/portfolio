#!/usr/bin/env python
# coding: utf-8

# In[15]:


import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from operator import attrgetter


# In[ ]:





# In[16]:


#### Задача № 1


# In[17]:


cust_data=pd.read_csv('olist_customers_dataset.csv')


# In[18]:


ord_data=pd.read_csv('olist_orders_dataset.csv')


# In[19]:


ord_items_data=pd.read_csv('olist_order_items_dataset.csv')


# In[20]:


cust_data


# In[21]:


ord_data


# In[22]:


ord_items_data


# In[23]:


half_merged=ord_data.merge(cust_data,on='customer_id',how='inner')


# In[24]:


final_data=half_merged.merge(ord_items_data,on='order_id',how='inner')


# In[25]:


final_data


# In[26]:


# N-day retention=  пользователи, пришедшие в день ноль / пользователи, вернувшиеся на N-день


# In[27]:


final_data_copy=final_data.copy()


# In[28]:


final_data_copy


# In[29]:



final_data_copy= final_data_copy[final_data_copy['order_status'] == 'delivered']


# In[30]:


final_data_copy['order_purchase_timestamp']=pd.to_datetime(final_data_copy['order_purchase_timestamp'])


# In[31]:


final_data_copy['order_period']=final_data_copy['order_purchase_timestamp'].dt.to_period('M')
final_data_cop2y['order_period_day']=final_data_copy['order_purchase_timestamp'].dt.to_period('D')


# In[32]:


final_data_copy['cohort']=final_data_copy.groupby('customer_unique_id')['order_purchase_timestamp'].transform('min').dt.to_period('M')
final_data_copy['cohort_day']=final_data_copy.groupby('customer_unique_id')['order_purchase_timestamp'].transform('min').dt.to_period('D')


# In[ ]:


final_data_copy['period_number_month']=np.floor((final_data_copy.order_period_day-final_data_copy.cohort_day).apply(attrgetter('n'))/30)


# In[4]:


final_data_copy


# In[ ]:


cohort_data = final_data_copy.groupby(['cohort','period_number_month']).agg(n_customers=('customer_unique_id', 'nunique')).reset_index()


# In[ ]:


final_data_copy.head()


# In[ ]:


cohort_pivot = cohort_data.pivot_table(index='cohort', columns='period_number_month', values='n_customers')


# In[ ]:


cohort_size = cohort_pivot.iloc[:, 0]


# In[ ]:


retention_matrix = cohort_pivot.divide(cohort_size, axis=0)


# In[ ]:


retention_matrix


# In[ ]:


cohort_pivot


# In[ ]:


median_retention_1st_month = retention_matrix[1].median()
print(f"Медианное удержание за первый месяц: {median_retention_1st_month:.2%}")


# In[ ]:


#Медианный retention 1-го месяца
median_retention_1st_month


# In[ ]:


# Когорта с самым высоким retention на 3-й месяц
max_retention_3rd_month = retention_matrix[3].idxmax()
print(f"Когорта с самым высоким retention на 3-й месяц: {max_retention_3rd_month}")


# In[ ]:


plt.figure(figsize=(12, 8))
sns.heatmap(retention_matrix, annot=True, fmt='.0%', cmap='Blues')
plt.show()


# In[ ]:


# Задача № 2


# In[ ]:


1)Исходя из результатов когортного анализа , product/market fit у данного маркетплейса отсутствует. 
Это означает, что продукт не находит достаточного спроса на рынке, не удовлетворяет потребности пользователей и не может удерживать их в долгосрочной перспективе.

2)Возможные причины:
    Недостаточное понимание целевой аудитории,cлабый пользовательский опыт,недостаток товаров или продавцов,низкое качество обслуживания,конкуренция,слабый маркетинг.


# In[ ]:


# Задача № 3


# In[ ]:


#1) Первая метрика должна отражать рост объёма продаж маркетплейса. = Общий объем продаж (GMV — Gross Merchandise Volume)

df=final_data

df['order_purchase_timestamp'] = pd.to_datetime(df['order_purchase_timestamp'])


monthly_sales = df.groupby(df['order_purchase_timestamp'].dt.to_period('M'))['price'].sum()


plt.figure(figsize=(10, 6))
monthly_sales.plot(kind='line', marker='o')
plt.title('Общий объем продаж по месяцам')
plt.xlabel('Месяц')
plt.ylabel('Объем продаж')
plt.grid(True)
plt.show()


# In[ ]:


# 2) Количество активных пользователей за месяц  = MAU
monthly_active_users = df.groupby(df['order_purchase_timestamp'].dt.to_period('M'))['customer_unique_id'].nunique()


plt.figure(figsize=(10, 6))
monthly_active_users.plot(kind='line', marker='o')
plt.title('Количество активных пользователей по месяцам')
plt.xlabel('Месяц')
plt.ylabel('Количество активных пользователей')
plt.grid(True)
plt.show()


# In[ ]:


# 3) Коэффициент конверсии новых пользователей (New User Conversion Rate)
Описание: Эта метрика показывает, насколько эффективно платформа привлекает новых клиентов и конвертирует их в покупателей.

Как измерять: Отношение числа новых пользователей, совершивших покупку, к общему числу новых пользователей за месяц.


# In[ ]:


# 4) Частота покупок (Purchase Frequency) Эта метрика отражает вовлеченность клиентов и показывает, как часто они возвращаются для совершения новых покупок.

user_monthly_orders = df.groupby([df['order_purchase_timestamp'].dt.to_period('M'), 'customer_unique_id']).size().reset_index(name='orders')


monthly_purchase_frequency = user_monthly_orders.groupby('order_purchase_timestamp')['orders'].mean()


plt.figure(figsize=(10, 6))
monthly_purchase_frequency.plot(kind='line', marker='o')
plt.title('Средняя частота покупок по месяцам')
plt.xlabel('Месяц')
plt.ylabel('Средняя частота покупок')
plt.grid(True)
plt.show()


# In[ ]:


# 5) Средний чек (Average Order Value — AOV)

monthly_aov = df.groupby(df['order_purchase_timestamp'].dt.to_period('M'))['price'].mean()


plt.figure(figsize=(10, 6))
monthly_aov.plot(kind='line', marker='o')
plt.title('Средний чек по месяцам')
plt.xlabel('Месяц')
plt.ylabel('Средний чек')
plt.grid(True)
plt.show()


# In[ ]:


# Задача № 4


# In[ ]:


final_data_copy2=final_data.query('order_purchase_timestamp >= "2017-06-01 00:00:00"')


# In[ ]:


final_data_copy2.query('order_status=="canceled"')


# Гипотеза 1: Исправление бага в системе процессинга заказов
# Предположение: Исправление бага устранит все отмены заказов.
# 
# Метрика: Количество отменённых заказов = 431.
# 
# Impact: По шкале 351 - 750 → Impact = 4.
# 
# Confidence: 8.
# 
# Ease: 6.
# 
# ICE: 
# 4×8×6=192

# In[ ]:


final_data_copy2['order_purchase_timestamp']=pd.to_datetime(final_data_copy2['order_purchase_timestamp'])


# In[ ]:


final_data_copy2['order_delivered_customer_date']=pd.to_datetime(final_data_copy2['order_delivered_customer_date'])


# In[ ]:


#mean_delivery_time=(final_data_copy2['order_delivered_customer_date'] - final_data_copy2['order_purchase_timestamp']).mean()


# In[ ]:


#mean_delivery_time=mean_delivery_time.days
#print(f"Среднее время доставки:{mean_delivery_time} дней")


# In[ ]:


final_data_copy2['order_estimated_delivery_date'] = pd.to_datetime(final_data_copy2['order_estimated_delivery_date'])
final_data_copy2['order_delivered_customer_date'] = pd.to_datetime(final_data_copy2['order_delivered_customer_date'])


# In[ ]:


count = (final_data_copy2['order_estimated_delivery_date'] < final_data_copy2['order_delivered_customer_date']).sum()
print(f"заказ с запаздыванием: {count}")


# Гипотеза № 2.
#   
# Метрика: Количество  заказов с опозданием  с 06.2017. Учитывая retention 0.0035, количество повторных заказов составит:
# 
# 8114 x 0.0035 = 28 повторных заказов
# Impact: По шкале 0 - 50 → Impact = 1.
# ICE: 1×10×4=40.    

# In[ ]:


final_data_copy2.groupby('customer_id').sum()


# In[ ]:


87140*0.0035


# Гипотеза № 3.
#   
# Метрика: Количество пользователей кто делал заказы с 06.2017. Учитывая retention 0.0035, количество повторных заказов составит:
# 
# 87140*0.0035 = 304.99 повторных заказов
# Impact: По шкале 151 - 350 → Impact = 3.
# ICE: 3×5×9=135.  

# ICE: 1) 192 , 
#      2) 40 , 
#      3) 135 .
#      Выбор первой гипотезы , так как она имеет наибольший ICE-балл и, следовательно, является наиболее приоритетной для реализации.

# In[ ]:


#Задание № 5


# выбранная гипотеза -
# Если исправим баг в системе процессинга заказов, то клиентам не придётся сталкиваться с проблемой отмены заказа, вследствие чего количество доставленных заказов увеличится. Считаем, что мы таким образом избавимся от всех отмен.

# In[ ]:


Метрики на которые должна повлиять выбранная гипотеза :
    #Целевые метрики (North Star Metrics)
1)Количество доставленных заказов:

Прямо отражает успех гипотезы, так как исправление бага увеличивает количество успешных заказов.

Это ключевой показатель для маркетплейса, так как напрямую влияет на выручку и удовлетворённость клиентов.

2)Выручка (Revenue):

Увеличение доставленных заказов и повторных покупок напрямую влияет на выручку.

Это основная финансовая метрика, которая отражает успех бизнеса.

3)Retention Rate (Удержание пользователей):

Показывает, насколько успешно продукт удерживает клиентов.

Это долгосрочная метрика, которая отражает здоровье бизнеса.

        #Прокси-метрики (Proxy Metrics)

1)Уровень отмен заказов (Cancellation Rate):

Показывает, насколько успешно устраняется проблема с отменами.

Это промежуточный показатель, который влияет на количество доставленных заказов и выручку.

2)Customer Satisfaction (CSAT) :

Отражает удовлетворённость клиентов, что может быть индикатором будущего роста Retention Rate и выручки.

Это косвенный показатель, который помогает оценить качество пользовательского опыта.

3)Средний Lifetime Value (LTV) клиента:

Показывает долгосрочную ценность клиента, что связано с Retention Rate и выручкой.

Это промежуточная метрика, которая помогает оценить долгосрочный эффект от улучшений.

        #Ограничивающие метрики (Guardrail Metrics)

1)Операционная эффективность:

Улучшение операционной эффективности (например, снижение нагрузки на поддержку) — это побочный эффект гипотезы.

Однако, если операционные процессы ухудшатся, это может негативно сказаться на бизнесе.

2)Количество негативных отзывов:

Уменьшение негативных отзывов — это положительный эффект, но их увеличение может сигнализировать о других проблемах.

Это ограничивающая метрика, которую нужно контролировать.


# In[ ]:


#Задание № 6
Формализация проблемы :
    Вы — аналитик данных, и сейчас идёте в стартап, который создает новый маркетплейс. Он недавно появился на рынке и занимается продажей новых товаров из Бразилии, которые только начинают поступать в продажу.
Продакт-менеджер Петя переживает за свой продукт, так как выручка маркетплейса стоит на месте уже несколько месяцев. Он предложил вам полную свободу действий. Главное — чтобы метрики росли, а мы не причиняли неудобства клиентам, ведь Петя заботится об их опыте.
Выводы :
Пункт 1) Медианный retention 1-го месяца = 0.0035
Когорта с самым высоким retention на 3-й месяц = 2017.01
    
Пункт 2) 
1.Исходя из результатов когортного анализа , product/market fit у данного маркетплейса отсутствует. 
Это означает, что продукт не находит достаточного спроса на рынке, не удовлетворяет потребности пользователей и не может удерживать их в долгосрочной перспективе.
2.Возможные причины:
Недостаточное понимание целевой аудитории,cлабый пользовательский опыт,недостаток товаров или продавцов,низкое качество обслуживания,конкуренция,слабый маркетинг.

Пункт 3) 
Определить 5 основных метрик, на которых продакт может сконцентрироваться, чтобы максимизировать прибыль компании.
1.Первая метрика должна отражать рост объёма продаж маркетплейса. = Общий объем продаж (GMV — Gross Merchandise Volume).
2.Вторая — показывать объем аудитории, которой продукт доставляет ценность =Количество активных пользователей за месяц  = MAU
3.Третья — отражать заинтересованность новых клиентов в продукте =Коэффициент конверсии новых пользователей (New User Conversion Rate)
4.Четвёртая — отражать вовлеченность клиента в продолжение использования продукта = Частота покупок (Purchase Frequency) Эта метрика отражает вовлеченность клиентов и показывает, как часто они возвращаются для совершения новых покупок.
5.Пятая — отражать денежное выражение вовлеченности клиента =Средний чек (Average Order Value — AOV)

Пункт 4) 
Выбрать одну из трёх основных гипотез с помощью фреймворка ICE, которые были сформированы продактом и, кажется, должны улучшить пользовательский опыт в маркетплейсе.
Выбор гипотезы № 1 , так как она имеет наибольший ICE-балл(192) и, следовательно, является наиболее приоритетной для реализации.

Пункт 5)
Выбранная гипотеза -"Если исправим баг в системе процессинга заказов, то клиентам не придётся сталкиваться с проблемой отмены заказа, вследствие чего количество доставленных заказов увеличится. Считаем, что мы таким образом избавимся от всех отмен."
Метрики на которые должна повлиять выбранная гипотеза :
    #Целевые метрики (North Star Metrics)
1.Количество доставленных заказов:

Прямо отражает успех гипотезы, так как исправление бага увеличивает количество успешных заказов.

Это ключевой показатель для маркетплейса, так как напрямую влияет на выручку и удовлетворённость клиентов.

2.Выручка (Revenue):

Увеличение доставленных заказов и повторных покупок напрямую влияет на выручку.

Это основная финансовая метрика, которая отражает успех бизнеса.

3.Retention Rate (Удержание пользователей):

Показывает, насколько успешно продукт удерживает клиентов.

Это долгосрочная метрика, которая отражает здоровье бизнеса.

        #Прокси-метрики (Proxy Metrics)

1.Уровень отмен заказов (Cancellation Rate):

Показывает, насколько успешно устраняется проблема с отменами.

Это промежуточный показатель, который влияет на количество доставленных заказов и выручку.

2.Customer Satisfaction (CSAT) :

Отражает удовлетворённость клиентов, что может быть индикатором будущего роста Retention Rate и выручки.

Это косвенный показатель, который помогает оценить качество пользовательского опыта.

3.Средний Lifetime Value (LTV) клиента:

Показывает долгосрочную ценность клиента, что связано с Retention Rate и выручкой.

Это промежуточная метрика, которая помогает оценить долгосрочный эффект от улучшений.

        #Ограничивающие метрики (Guardrail Metrics)

1.Операционная эффективность:

Улучшение операционной эффективности (например, снижение нагрузки на поддержку) — это побочный эффект гипотезы.

Однако, если операционные процессы ухудшатся, это может негативно сказаться на бизнесе.

2.Количество негативных отзывов:

Уменьшение негативных отзывов — это положительный эффект, но их увеличение может сигнализировать о других проблемах.

Это ограничивающая метрика, которую нужно контролировать.


Общие выводы:

Основная проблема продукта заключается в отсутствии product/market fit, что подтверждается низким retention (0.0035) и стагнацией выручки.

Когортный анализ показал, что продукт не удерживает пользователей в долгосрочной перспективе, что связано с недостаточным пониманием целевой аудитории, слабым пользовательским опытом и другими факторами.

Для улучшения ситуации необходимо сконцентрироваться на ключевых метриках, таких как GMV, MAU, конверсия новых пользователей, частота покупок и средний чек.

Гипотеза "Исправление бага в системе процессинга заказов" выбрана как наиболее приоритетная, так как она имеет наибольший ICE-балл и потенциал для улучшения ключевых метрик.

Целевые метрики на которые эта гипотеза может повлиять : 
1.Количество доставленных заказов
2.Выручка (Revenue)
3.Retention Rate 

# Рекомендации по продукту:
1.Исправление бага в системе процессинга заказов:

Немедленно устраните баг, чтобы уменьшить количество отмен и увеличить количество доставленных заказов.

2.Улучшение пользовательского опыта:

Проведите исследование целевой аудитории, чтобы лучше понять её потребности.

Упростите процесс оформления заказа и улучшите навигацию на сайте.

3.Увеличение Retention Rate:

Внедрите программы лояльности и персонализированные предложения для удержания клиентов.

Улучшите качество обслуживания и коммуникацию с клиентами.

4.Увеличение количества активных пользователей (MAU):

Усильте маркетинговые усилия, чтобы привлечь новых пользователей.

Используйте ретаргетинг для возврата ушедших клиентов.

5.Увеличение среднего чека (AOV):

Внедрите рекомендации товаров и перекрёстные продажи.

Предложите клиентам дополнительные услуги или премиальные товары.

6.Мониторинг ключевых метрик:

Внедрите систему аналитики для отслеживания GMV, MAU, конверсии новых пользователей, частоты покупок и среднего чека.

Регулярно анализируйте данные, чтобы оперативно выявлять проблемы и улучшать продукт.

7.Тестирование гипотез:

Перед полным внедрением изменений проводите A/B-тестирование, чтобы минимизировать риски и оценить эффективность.

8.Улучшение операционной эффективности:

Оптимизируйте процессы обработки заказов и снизьте нагрузку на службу поддержки.


# In[ ]:





# In[ ]:




